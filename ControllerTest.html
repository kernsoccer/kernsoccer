<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title></title>
<script>
    var ControllerManager = function () {
        var gamepads = navigator.getGamepads();
        var controllers = [
            new Controller(),
            new Controller(),
            new Controller(),
            new Controller()
        ]

        function update() {
            gamepads = navigator.getGamepads();
            for (var i = 0; i < gamepads.length; i++) {
                controllers[i].update(gamepads[i]);
            }
        }

        return {
            update: update,
            controllers: controllers
        }
    };
    
    var Controller = function () {
        var mapping;
        var state;
        var toggles = [];
        var connected = false;

        function setMapping(newMapping) {
            mapping = JSON.parse(JSON.stringify(newMapping));
            toggles = [];
            for (var key in mapping) {
                var map = mapping[key];
                if (!map.toggle) {
                    continue;
                }
                map.pressed = false;
                map.wasPressed = false;
                toggles.push(map);
            }
        }

        function getVector(map) {
            if (!state || !state.axes) {
                return {
                    x: 0,
                    y: 0
                }
            }
            return {
                x: map.xaxis < state.axes.length ? state.axes[map.xaxis] : 0,
                y: map.yaxis < state.axes.length ? state.axes[map.yaxis] : 0
            }
        }

        function getButton(map) {
            if (!state) {
                return false;
            }
            if (map.toggle) {
                return map.pressed;
            }
            return checkButtons(map.buttons);
        }

        function getAxisButton(map) {
            if (!state) {
                return false;
            }
            if (map.toggle) {
                return map.pressed;
            }
            return checkAxisButtons(map.axes, map.threshold);
        }

        function checkButtons(buttons) {
            if (!state) {
                return false;
            }
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i] < state.buttons.length
                    && state.buttons[buttons[i]].pressed) {
                    return true;
                }
            }
            return false;
        }

        function checkAxisButtons(axes, threshold) {
            if (!state || !state.axes) {
                return false;
            }

            for (var i = 0; i < axes.length; i++) {
                if (axes[i] < state.axes.length) {
                    if (threshold < 0 && state.axes[axes[i]] < threshold) {
                        return true;
                    }
                    if (threshold > 0 && state.axes[axes[i]] > threshold) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        function get(name) {
            if (!mapping || !mapping[name]) {
                return undefined;
            }
            var map = mapping[name];
            switch (map.type) {
                case "button":
                    return getButton(map);
                case "vector":
                    return getVector(map);
                case "axisbutton":
                    return getAxisButton(map);
            }
            return undefined;
        }
        
        function update(gamepadState) {
            state = gamepadState;
            if (state == undefined) {
                connected = false;
                return;
            }
            for (var i = 0; i < toggles.length; i++) {
                var map = toggles[i];
                if (map.wasPressed) {
                    map.pressed = false;
                    map.wasPressed = (map.type == "button")
                        ? checkButtons(map.buttons)
                        : checkAxisButtons(map.axes, map.threshold);
                }
                else {
                    map.pressed = (map.type == "button")
                        ? checkButtons(map.buttons)
                        : checkAxisButtons(map.axes, map.threshold);
                    map.wasPressed = map.pressed;
                }
            }
        }

        return {
            update: update,
            setMapping: setMapping,
            get: get,
            connected: connected
        }
    }

    var ctlrMgr = new ControllerManager();
    var ctlr = ctlrMgr.controllers[0];
    ctlr.setMapping({
        pause: {
            type: "button",
            buttons: [9],
            toggle: true
        },
        kicking: {
            type: "button",
            buttons: [0, 4],
            toggle: false
        },
        input: {
            type: "vector",
            xaxis: 0,
            yaxis: 1
        },
        menuLeft: {
            type: "axisbutton",
            axes: [0],
            threshold: -0.8,
            toggle: true
        },
        moveRight: {
            type: "axisbutton",
            axes: [0],
            threshold: 0.8,
            toggle: false
        }
    });

    function update() {
        ctlrMgr.update();
        if (ctlr.get("kicking")) {
            var vect = ctlr.get("input");
            console.log("kicking: " + vect.x + ", " + vect.y);
        }
        if (ctlr.get("pause")) {
            console.log("pause");
        }
        if (ctlr.get("menuLeft")) {
            console.log("menuLeft");
        }
        if (ctlr.get("moveRight")) {
            console.log("moveRight");
        }
        
        window.requestAnimationFrame(update);
    }

window.requestAnimationFrame(update);
        
</script>
</head>
<body>

</body>
</html>